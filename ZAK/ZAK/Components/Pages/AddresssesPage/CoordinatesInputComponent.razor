@using System.ComponentModel.DataAnnotations;
@using ZAK.DA;


@inject IDao<Address, AddressModel> addressDataAccess;
@inject ILogger<CoordinatesInputComponent> _logger;

<InputNumber TValue="double" @bind-Value="@coordinate" @bind-Value:after="UpdateDbData" />



@code {
    [Parameter] public int addressId { get; set; }

    [Parameter] public double coordinate { get; set; } = 0.0;
 
    [Parameter] public bool Lat { get; set; } = false;
    [Parameter] public bool Lon { get; set; } = false;

    private async Task UpdateDbData()
    {
        _logger.LogInformation($"Updating coordinates for address with id {addressId} to {coordinate}");

        Address address = (await addressDataAccess.GetAll(query => query.Include(x =>  x.coordinates).Where(x => x.Id == addressId))).FirstOrDefault()!;

        if(address.coordinates is null)
        {
            address.coordinates = new AddressCoordinates();
        }

        if (Lat)
        {
            address.coordinates.lat = coordinate;
        }
        else if (Lon)
        {
            address.coordinates.lon = coordinate;
        }

        await addressDataAccess.Update(
            address, 
            addressId, 
            findPredicate: a => a.Id == addressId,
            includeQuery: a => a.Include(x => x.coordinates)
            );
    }
}  